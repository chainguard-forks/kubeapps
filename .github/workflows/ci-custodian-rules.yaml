# Copyright 2022 the Kubeapps contributors.
# SPDX-License-Identifier: Apache-2.0

---
name: Kubeapps Custodian Rules
on:
  schedule:
    - cron: "0 8 * * *"
env:
  GOOGLE_APPLICATION_CREDENTIALS: key.json
  GCLOUD_CUSTODIAN_KEY: ${{ secrets.GCLOUD_CUSTODIAN_KEY }}
  CLOUDSDK_CORE_PROJECT: ${{ secrets.GOOGLE_CLOUD_PROJECT }}
jobs:
  remove-unattached-disks:
    if: github.repository == 'vmware-tanzu/kubeapps'
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: gscho/setup-cloud-custodian@7ef0768aceae6ab41ee5663fbe62676b2cc562e3 # v1
        with:
          include-gcp: true
      - run: echo $GCLOUD_CUSTODIAN_KEY > $GOOGLE_APPLICATION_CREDENTIALS
      - run: custodian run -s out .github/workflows/custodian-rules/remove-unattached-disks.yaml
